<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>SpendTracker Stealth</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CORE RESET */
        html { background-color: #000000; }
        body { 
            background-color: #000000; 
            color: #FFFFFF; 
            -webkit-tap-highlight-color: transparent; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            overscroll-behavior-y: none;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .app-container { 
            max-width: 28rem; 
            margin: 0 auto; 
            width: 100%; 
            padding: 1.5rem; 
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* --- THE CONTROL GRID (2x2) --- */
        .control-card {
            background: #1c1c1e;
            border: 1px solid #27272a;
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100px; /* Fixed height for consistency */
            position: relative;
            transition: all 0.1s;
        }
        .control-card:active { transform: scale(0.96); background: #27272a; }
        
        /* Specific Styles for Quadrants */
        .btn-add { background: #FFFFFF; color: #000000; border-color: #FFFFFF; }
        .btn-add:active { background: #e4e4e7; }
        
        .btn-sum { color: #a1a1aa; }
        .btn-sum.active { background: #333; color: #FFF; border-color: #555; }

        /* --- STACK ITEMS --- */
        .stack-list { display: flex; flex-direction: column; padding-bottom: 40px; }
        .stack-item { 
            border: 1px solid #27272a; margin-bottom: -1px; padding: 16px; background: #000000;
        }
        .stack-item:first-child { border-top-left-radius: 20px; border-top-right-radius: 20px; }
        .stack-item:last-child { border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; border-bottom: 1px solid #27272a; margin-bottom: 0; }
        
        /* --- INPUT MODE OVERLAY --- */
        /* Takes over the grid area when active */
        .input-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000000; z-index: 50; padding: 1.5rem;
            display: flex; flex-direction: column;
        }
        
        /* Categories Grid */
        .category-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; flex: 1; overflow-y: auto; }
        .category-btn { 
            background: #1c1c1e; border: 1px solid #27272a; 
            border-radius: 16px; height: 60px; 
            font-weight: 800; font-size: 12px; uppercase; 
            display: flex; align-items: center; justify-content: center;
        }
        .category-btn:active { background: #333; border-color: #fff; }

        /* --- VISUALS --- */
        .pill { font-size: 10px; font-weight: 900; padding: 4px 8px; border-radius: 6px; text-transform: uppercase; }
        .pill-good { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
        .pill-bad { background: rgba(239, 68, 68, 0.15); color: #f87171; }
        .pill-neutral { background: rgba(255, 255, 255, 0.05); color: #71717a; }

        .summary-fill { position: absolute; top: 0; left: 0; bottom: 0; opacity: 0.25; z-index: 0; }
        .summary-content { position: relative; z-index: 10; display: flex; justify-content: space-between; align-items: center; width: 100%; }

        /* Graph */
        .chart-line { fill: none; stroke: #fff; stroke-width: 2px; stroke-linecap: round; stroke-linejoin: round; }
        .chart-area { fill: url(#gradient); opacity: 0.3; }

        /* Scroller */
        .date-scroller { display: flex; overflow-x: auto; gap: 8px; padding: 10px 0; scroll-snap-type: x mandatory; }
        .date-scroller::-webkit-scrollbar { display: none; }
        .date-card { scroll-snap-align: center; flex: 0 0 60px; height: 75px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #1c1c1e; border-radius: 12px; border: 1px solid #27272a; }
        .date-card.selected { background: #FFFFFF; color: #000000; border-color: #FFFFFF; }

        .hidden { display: none !important; }
        input::placeholder { color: #333; }
    </style>
</head>
<body class="font-sans text-sm">
    <div class="app-container">
        
        <div class="flex justify-between items-center mb-6 px-2">
            <button onclick="changeMonth(-1)" class="text-zinc-600 text-2xl font-black p-2"><<<</button>
            <span onclick="jumpToToday()" id="currentMonthLabel" class="text-xs font-black uppercase tracking-[0.2em] text-zinc-400 cursor-pointer">JANUARY 2026</span>
            <button onclick="changeMonth(1)" class="text-zinc-600 text-2xl font-black p-2">>>></button>
        </div>

        <div class="mb-8 px-2">
            <h2 id="totalDisplay" class="text-6xl font-black tabular-nums tracking-tighter text-white leading-none mb-4">0 Ft</h2>
            <div class="w-full h-1 bg-zinc-900 rounded-full overflow-hidden">
                <div id="waterlineFill" class="h-full bg-white transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-8">
            
            <button onclick="openInputMode()" class="control-card btn-add">
                <span class="text-4xl font-black">+</span>
            </button>

            <div class="control-card">
                <span class="text-[9px] font-black uppercase text-zinc-600 tracking-widest mb-1">VS LAST MONTH</span>
                <div id="comparisonContainer">
                    <span class="pill pill-neutral">--</span>
                </div>
            </div>

            <button onclick="setBudget()" class="control-card">
                <span class="text-[9px] font-black uppercase text-zinc-600 tracking-widest mb-1">REMAINING</span>
                <span id="budgetLeftLabel" class="text-lg font-bold tabular-nums text-white">--</span>
            </button>

            <button onclick="toggleSummary()" id="btnSummary" class="control-card btn-sum">
                <span class="text-sm font-black uppercase tracking-widest">SUM</span>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto -mx-2 px-2">
            
            <div id="activityView">
                <h3 class="text-[10px] font-black uppercase tracking-widest text-zinc-800 mb-3 ml-1">Recent Activity</h3>
                <ul id="expenseList" class="stack-list"></ul>
            </div>

            <div id="summaryView" class="hidden">
                <h3 class="text-[10px] font-black uppercase tracking-widest text-zinc-800 mb-3 ml-1">Breakdown</h3>
                <ul id="summaryList" class="stack-list mb-8"></ul>
                
                <div class="p-4 bg-[#1c1c1e] rounded-3xl border border-zinc-800 mb-8">
                    <h3 class="text-[9px] font-black uppercase tracking-widest text-zinc-500 mb-4">Trend (This Month)</h3>
                    <div class="h-32 w-full flex items-end">
                        <svg id="spendingChart" class="w-full h-full overflow-visible" preserveAspectRatio="none"></svg>
                    </div>
                </div>
            </div>
        </div>

        <div id="inputOverlay" class="input-overlay hidden">
            <div class="flex justify-between items-center mb-6">
                <button onclick="closeInputMode()" class="text-zinc-500 font-bold text-xs uppercase tracking-widest">Cancel</button>
                <span class="text-zinc-700 font-black text-xs uppercase tracking-widest">New Entry</span>
                <button onclick="addNewCategory()" class="text-white font-bold text-xs uppercase tracking-widest">+ Cat</button>
            </div>

            <input id="amountInput" type="text" inputmode="decimal" placeholder="0" 
                class="w-full bg-transparent border-b-2 border-zinc-800 py-4 text-6xl font-black text-center outline-none focus:border-white transition-colors mb-8 text-white">

            <div id="categoryGrid" class="category-grid mb-6"></div>

            <div class="mt-auto">
                <span class="text-[9px] font-bold text-zinc-600 uppercase tracking-widest block mb-3 text-center">Select Date</span>
                <div id="dateScroller" class="date-scroller"></div>
            </div>
        </div>

        <div class="mt-4 flex justify-between items-center opacity-20">
            <button onclick="exportToCSV()" class="text-[9px] font-bold uppercase tracking-widest">CSV</button>
            <button onclick="clearAll()" class="text-[9px] font-bold uppercase tracking-widest text-red-900">Reset</button>
        </div>
    </div>

    <script>
        // CONFIG
        const PALETTE = ['#1c1c1e', '#2c2c2e', '#3a3a3c', '#48484a', '#636366', '#8e8e93', '#c7c7cc', '#F8F8F2'];
        
        // STATE
        let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
        let categories = JSON.parse(localStorage.getItem('categories')) || ['Food', 'Transport', 'Rent', 'Tech', 'Health', 'Fun'];
        let categoryUsage = JSON.parse(localStorage.getItem('categoryUsage')) || {};
        let categoryColors = JSON.parse(localStorage.getItem('categoryColors')) || {};
        let budgetLimit = parseFloat(localStorage.getItem('budgetLimit')) || 0;
        
        let viewDate = new Date();
        let selectedTimestamp = new Date().setHours(12,0,0,0);
        let isSummaryMode = false;

        // --- CORE FUNCTIONS ---

        function init() {
            renderAll();
        }

        // --- INPUT MODE LOGIC ---

        function openInputMode() {
            document.getElementById('inputOverlay').classList.remove('hidden');
            document.getElementById('amountInput').value = '';
            document.getElementById('amountInput').focus();
            
            // Default date to today/view month
            syncSelectedDateToView();
            renderCategories();
            renderDateScroller();
        }

        function closeInputMode() {
            document.getElementById('inputOverlay').classList.add('hidden');
            document.getElementById('amountInput').blur();
        }

        function saveTransaction(cat) {
            const raw = document.getElementById('amountInput').value.replace(/\s+/g, '');
            if(!raw) return;
            
            const amt = parseFloat(raw);
            expenses.push({ 
                category: cat, 
                amount: amt, 
                date: selectedTimestamp,
                color: getColor(cat)
            });
            
            // Update usage
            categoryUsage[cat] = (categoryUsage[cat] || 0) + 1;
            localStorage.setItem('categoryUsage', JSON.stringify(categoryUsage));
            
            closeInputMode();
            renderAll();
        }

        // --- RENDERERS ---

        function renderAll() {
            // Save state
            localStorage.setItem('expenses', JSON.stringify(expenses));

            // Header
            document.getElementById('currentMonthLabel').innerText = viewDate.toLocaleString('en-US', { month: 'long', year: 'numeric' });

            // Filter for View Date
            const currentMonthData = expenses.filter(e => {
                const d = new Date(e.date);
                return d.getMonth() === viewDate.getMonth() && d.getFullYear() === viewDate.getFullYear();
            }).sort((a,b) => b.date - a.date);

            // Calculate Total
            const total = currentMonthData.reduce((sum, e) => sum + e.amount, 0);
            document.getElementById('totalDisplay').innerText = `${total.toLocaleString('hu-HU').replace(/,/g, ' ')} Ft`;

            // 1. Render Activity List
            const listEl = document.getElementById('expenseList');
            listEl.innerHTML = currentMonthData.map((e, i) => {
                // Find original index for deletion (simple find for now)
                const originalIndex = expenses.indexOf(e);
                const col = getColor(e.category);
                return `
                <li class="stack-item flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-1 h-8 rounded-full" style="background:${col}"></div>
                        <div class="flex flex-col">
                            <span class="text-sm font-black uppercase tracking-tight">${e.category}</span>
                            <span class="text-[9px] font-bold opacity-40 uppercase">${new Date(e.date).toLocaleDateString('hu-HU')}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-black text-md tabular-nums">${Math.round(e.amount).toLocaleString('hu-HU')}</span>
                        <button onclick="deleteItem(${originalIndex})" class="text-xl opacity-20 hover:opacity-100 px-2">×</button>
                    </div>
                </li>`;
            }).join('');

            // 2. Render Summary List (Hidden but ready)
            renderSummaryList(currentMonthData, total);

            // 3. Update Control Grid Data
            updateControlGrid(total);
        }

        function updateControlGrid(currentTotal) {
            // A. Budget Remaining
            const budgetLabel = document.getElementById('budgetLeftLabel');
            const waterline = document.getElementById('waterlineFill');
            
            if (budgetLimit > 0) {
                const left = budgetLimit - currentTotal;
                budgetLabel.innerText = `${left.toLocaleString('hu-HU')} Ft`;
                budgetLabel.style.color = left < 0 ? '#f87171' : '#FFFFFF';
                
                const pct = Math.min((currentTotal / budgetLimit) * 100, 100);
                waterline.style.width = `${pct}%`;
                waterline.style.backgroundColor = pct > 90 ? '#f87171' : '#FFFFFF';
            } else {
                budgetLabel.innerText = "Set";
                budgetLabel.style.color = "#555";
                waterline.style.width = '0%';
            }

            // B. Comparison (Same Day Logic)
            const todayDay = new Date().getDate(); // Current Day of Month
            
            // Get Previous Month Total (up to same day)
            let prevMonthIdx = viewDate.getMonth() - 1;
            let prevYear = viewDate.getFullYear();
            if (prevMonthIdx < 0) { prevMonthIdx = 11; prevYear -= 1; }

            const prevExpenses = expenses.filter(e => {
                const d = new Date(e.date);
                return d.getMonth() === prevMonthIdx && 
                       d.getFullYear() === prevYear && 
                       d.getDate() <= todayDay; // Compare apples to apples
            });
            const prevTotal = prevExpenses.reduce((sum, e) => sum + e.amount, 0);

            const compContainer = document.getElementById('comparisonContainer');
            if (prevTotal > 0) {
                const diff = currentTotal - prevTotal;
                const pct = ((diff / prevTotal) * 100).toFixed(0);
                if (diff < 0) compContainer.innerHTML = `<span class="pill pill-good">↓ ${Math.abs(pct)}%</span>`;
                else if (diff > 0) compContainer.innerHTML = `<span class="pill pill-bad">↑ ${Math.abs(pct)}%</span>`;
                else compContainer.innerHTML = `<span class="pill pill-neutral">=</span>`;
            } else {
                compContainer.innerHTML = `<span class="pill pill-neutral">--</span>`;
            }
        }

        function renderSummaryList(data, grandTotal) {
            const totals = {};
            data.forEach(e => totals[e.category] = (totals[e.category] || 0) + e.amount);
            const sorted = Object.entries(totals).sort((a,b) => b[1] - a[1]);

            const html = sorted.map(([cat, amt]) => {
                const col = getColor(cat);
                const pct = grandTotal > 0 ? (amt / grandTotal * 100).toFixed(0) : 0;
                return `
                <li class="stack-item">
                    <div class="summary-fill" style="width: ${pct}%; background-color: ${col};"></div>
                    <div class="summary-content">
                        <span class="text-sm font-black uppercase tracking-tight">${cat}</span>
                        <span class="text-md font-black tabular-nums">${Math.round(amt).toLocaleString('hu-HU')} Ft</span>
                    </div>
                </li>`;
            }).join('');
            document.getElementById('summaryList').innerHTML = html;
            
            renderGraph(data);
        }

        function renderCategories() {
            const sorted = [...categories].sort((a,b) => (categoryUsage[b]||0) - (categoryUsage[a]||0));
            document.getElementById('categoryGrid').innerHTML = sorted.map(c => {
                return `<button onclick="saveTransaction('${c}')" class="category-btn text-white uppercase">${c}</button>`;
            }).join('');
        }

        function renderDateScroller() {
            const daysInMonth = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 0).getDate();
            let html = '';
            for(let i=1; i<=daysInMonth; i++) {
                const ts = new Date(viewDate.getFullYear(), viewDate.getMonth(), i).setHours(12,0,0,0);
                const isSel = ts === selectedTimestamp;
                html += `<div onclick="selectedTimestamp=${ts}; renderDateScroller()" class="date-card ${isSel?'selected':''}">
                    <span class="text-[9px] font-bold uppercase">DAY</span>
                    <span class="text-lg font-black">${i}</span>
                </div>`;
            }
            document.getElementById('dateScroller').innerHTML = html;
        }

        function renderGraph(data) {
            // Simple daily aggregation
            const days = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 0).getDate();
            const daily = new Array(days).fill(0);
            data.forEach(e => {
                const d = new Date(e.date).getDate();
                daily[d-1] += e.amount;
            });
            
            const max = Math.max(...daily, 10);
            const svg = document.getElementById('spendingChart');
            const w = svg.clientWidth || 300; const h = 128;
            const step = w / (days-1);
            
            let pts = "";
            let area = `0,${h} `;
            
            daily.forEach((val, i) => {
                const x = i * step;
                const y = h - ((val/max) * (h*0.8)); // 80% height max
                pts += `${x},${y} `;
                area += `${x},${y} `;
            });
            area += `${w},${h}`;
            
            svg.innerHTML = `
                <defs>
                    <linearGradient id="gradient" x1="0" y1="0" x2="0" y2="1"><stop offset="0" stop-color="white" stop-opacity="0.2"/><stop offset="1" stop-color="white" stop-opacity="0"/></linearGradient>
                </defs>
                <polygon points="${area}" class="chart-area" />
                <polyline points="${pts}" class="chart-line" />
            `;
        }

        // --- UTILS ---
        
        function toggleSummary() {
            isSummaryMode = !isSummaryMode;
            document.getElementById('btnSummary').classList.toggle('active', isSummaryMode);
            document.getElementById('activityView').classList.toggle('hidden', isSummaryMode);
            document.getElementById('summaryView').classList.toggle('hidden', !isSummaryMode);
        }

        function syncSelectedDateToView() {
            const now = new Date();
            // If viewing current month, default to today. Else 1st.
            if(now.getMonth() === viewDate.getMonth()) selectedTimestamp = new Date().setHours(12,0,0,0);
            else selectedTimestamp = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).setHours(12,0,0,0);
        }

        function getColor(cat) {
            if(!categoryColors[cat]) {
                categoryColors[cat] = PALETTE[Object.keys(categoryColors).length % PALETTE.length];
                localStorage.setItem('categoryColors', JSON.stringify(categoryColors));
            }
            return categoryColors[cat];
        }

        // Listeners
        document.getElementById('amountInput').addEventListener('input', (e) => {
            e.target.value = Number(e.target.value.replace(/[^0-9]/g, '')).toLocaleString('hu-HU').replace(/,/g,' ');
        });

        // Global Actions
        window.changeMonth = (d) => { viewDate.setMonth(viewDate.getMonth()+d); renderAll(); };
        window.jumpToToday = () => { viewDate = new Date(); renderAll(); };
        window.setBudget = () => { 
            const n = prompt("Monthly Limit:", budgetLimit); 
            if(n!==null) { budgetLimit = parseFloat(n); localStorage.setItem('budgetLimit', budgetLimit); renderAll(); }
        };
        window.addNewCategory = () => {
            const n = prompt("New Category:");
            if(n && !categories.includes(n)) { categories.push(n); localStorage.setItem('categories', JSON.stringify(categories)); renderCategories(); }
        };
        window.deleteItem = (i) => {
            if(confirm("Delete item?")) { expenses.splice(i,1); renderAll(); }
        };
        window.clearAll = () => { if(confirm("Reset App?")) { localStorage.clear(); location.reload(); }};
        window.exportToCSV = () => {
            let csv = "Date,Category,Amount\n" + expenses.map(e => `"${new Date(e.date).toLocaleDateString()}","${e.category}",${e.amount}`).join("\n");
            const blob = new Blob([csv],{type:'text/csv'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='data.csv'; a.click();
        };

        // Start
        init();
    </script>
</body>
</html>
