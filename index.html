<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>SpendTracker Cloud</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* CORE RESET */
        html { background-color: #000000; }
        body { 
            background-color: #000000; 
            color: #FFFFFF; 
            -webkit-tap-highlight-color: transparent; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            overflow-x: hidden;
        }

        .app-container { 
            max-width: 28rem; 
            margin: 0 auto; 
            width: 100%; 
            padding: 1.5rem; 
            display: flex; 
            flex-direction: column;
            flex: 1;
        }
        
        /* --- CONTROL GRID --- */
        .control-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 100px 100px;
            gap: 8px;
            margin-bottom: 2rem;
        }
        .control-card {
            background: #1c1c1e;
            border: 1px solid #27272a;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: transform 0.1s;
        }
        .control-card:active { transform: scale(0.98); background: #27272a; }
        .btn-add { background: #FFFFFF; color: #000000; border-color: #FFFFFF; }
        .btn-add:active { background: #e4e4e7; }
        .btn-sum { color: #a1a1aa; }
        .btn-sum:active { background: #333; color: #FFF; }

        /* --- LISTS --- */
        .stack-list { display: flex; flex-direction: column; padding-bottom: 40px; }
        .stack-item { 
            margin-bottom: -1px; 
            padding: 18px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.1);
            transition: filter 0.2s;
        }
        .stack-item:active { filter: brightness(1.2); }
        .stack-item:first-child { border-top-left-radius: 24px; border-top-right-radius: 24px; }
        .stack-item:last-child { border-bottom-left-radius: 24px; border-bottom-right-radius: 24px; border-bottom: none; margin-bottom: 0; }

        /* --- SUMMARY --- */
        .summary-fill {
            position: absolute; top: 0; left: 0; bottom: 0;
            z-index: 0; opacity: 0.3; width: 0%;
            transition: width 1.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .item-content { position: relative; z-index: 10; width: 100%; display: flex; justify-content: space-between; align-items: center; }

        /* --- INPUT OVERLAY --- */
        .input-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000000; z-index: 100; padding: 1.5rem;
            display: flex; flex-direction: column;
        }
        .category-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; flex: 1; overflow-y: auto; padding-bottom: 20px; }
        .category-btn { 
            background: #1c1c1e; border: 1px solid #27272a; 
            border-radius: 16px; height: 60px; 
            font-weight: 800; font-size: 12px; text-transform: uppercase; 
            display: flex; align-items: center; justify-content: center;
        }
        .category-btn:active { background: #333; border-color: #fff; }
        .category-btn.active-edit { 
            background: #FFFFFF !important; color: #000000 !important; border-color: #FFFFFF !important;
            box-shadow: 0 0 15px rgba(255,255,255,0.3);
        }

        /* --- VISUALS --- */
        .pill { font-size: 10px; font-weight: 900; padding: 3px 6px; border-radius: 6px; text-transform: uppercase; }
        .pill-good { background: rgba(34, 197, 94, 0.3); color: #4ade80; }
        .pill-bad { background: rgba(239, 68, 68, 0.3); color: #f87171; }
        .pill-neutral { background: rgba(255, 255, 255, 0.1); color: #a1a1aa; }

        .chart-line { fill: none; stroke: #fff; stroke-width: 2px; stroke-linecap: round; stroke-linejoin: round; }
        .chart-area { fill: url(#gradient); opacity: 0.3; }

        .date-scroller { display: flex; overflow-x: auto; gap: 8px; padding: 10px 0; scroll-snap-type: x mandatory; }
        .date-scroller::-webkit-scrollbar { display: none; }
        .date-card { scroll-snap-align: center; flex: 0 0 60px; height: 75px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #1c1c1e; border-radius: 12px; border: 1px solid #27272a; }
        .date-card.selected { background: #FFFFFF; color: #000000; border-color: #FFFFFF; }

        .waterline-container { height: 4px; width: 100%; background: #1c1c1e; border-radius: 2px; overflow: hidden; margin-top: 12px; }
        .waterline-fill { height: 100%; background: #333; width: 0%; transition: width 0.5s ease-out; }

        .hidden { display: none !important; }
        input::placeholder { color: #333; }
        
        /* SPINNER */
        .spinner { border: 2px solid rgba(255,255,255,0.1); border-top: 2px solid #fff; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="font-sans text-sm">
    <div class="app-container">
        
        <div class="flex justify-between items-center mb-8 px-2">
            <button onclick="changeMonth(-1)" class="text-zinc-500 text-2xl font-black p-2 hover:text-white"><<<</button>
            <span id="currentMonthLabel" class="text-xs font-black uppercase tracking-[0.25em] text-white">JANUARY 2026</span>
            <button onclick="changeMonth(1)" class="text-zinc-500 text-2xl font-black p-2 hover:text-white">>>></button>
        </div>

        <div class="mb-8 px-2">
            <h2 id="totalDisplay" class="text-5xl font-black tabular-nums tracking-tighter text-white leading-none">0 Ft</h2>
            <div class="waterline-container"><div id="waterlineFill" class="waterline-fill"></div></div>
        </div>

        <div id="controlGrid" class="control-grid">
            <button onclick="openInputMode(true)" class="control-card btn-add"><span class="text-4xl font-black">+</span></button>
            <div class="control-card">
                <span class="text-[9px] font-black uppercase text-zinc-600 tracking-widest mb-2">VS PREV MONTH</span>
                <div id="comparisonContainer"><span class="pill pill-neutral">--</span></div>
            </div>
            <button onclick="setBudget()" class="control-card">
                <span class="text-[9px] font-black uppercase text-zinc-600 tracking-widest mb-1">REMAINING</span>
                <span id="budgetLeftLabel" class="text-lg font-bold tabular-nums text-white">--</span>
            </button>
            <button onclick="toggleView()" class="control-card btn-sum"><span class="text-sm font-black uppercase tracking-widest">SUM</span></button>
        </div>

        <div class="flex-1">
            <div id="activityView">
                <div class="flex justify-between items-center mb-3 px-2">
                    <h3 class="text-[10px] font-black uppercase tracking-widest text-zinc-700">History</h3>
                    <div id="loadingIndicator" class="spinner hidden"></div>
                </div>
                <ul id="expenseList" class="stack-list"></ul>
            </div>

            <div id="summaryView" class="hidden">
                <div class="flex justify-between items-center mb-6 px-2">
                    <h3 class="text-[10px] font-black uppercase tracking-widest text-zinc-500">Breakdown</h3>
                    <button onclick="toggleView()" class="text-[10px] font-bold uppercase tracking-widest text-white bg-zinc-900 px-3 py-2 rounded-full">Back</button>
                </div>
                <ul id="summaryList" class="stack-list mb-8"></ul>
                <div class="p-4 bg-[#1c1c1e] rounded-3xl border border-zinc-800 mb-8">
                    <h3 class="text-[9px] font-black uppercase tracking-widest text-zinc-500 mb-4">Trend</h3>
                    <div class="h-32 w-full flex items-end">
                        <svg id="spendingChart" class="w-full h-full overflow-visible" preserveAspectRatio="none"></svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="inputOverlay" class="input-overlay hidden">
        <div class="flex justify-between items-center mb-6">
            <button onclick="closeInputMode()" class="text-zinc-500 font-bold text-xs uppercase tracking-widest">Cancel</button>
            <span id="inputHeaderLabel" class="text-zinc-700 font-black text-xs uppercase tracking-widest">Add New</span>
            <button onclick="addNewCategory()" class="text-white font-bold text-xs uppercase tracking-widest">+ Cat</button>
        </div>
        
        <input id="amountInput" type="text" inputmode="decimal" placeholder="0" 
            class="w-full bg-transparent border-b-2 border-zinc-800 py-6 text-6xl font-black text-center outline-none focus:border-white transition-colors mb-4 text-white">
        
        <div id="dateLocationTop" class="mb-4"></div>
        <div id="categoryGrid" class="category-grid mb-6"></div>
        <div id="dateLocationBottom" class="mt-auto"></div>
        
        <div id="dateScrollerWrapper" class="hidden">
            <span class="text-[9px] font-bold text-zinc-600 uppercase tracking-widest block mb-3 text-center">Select Date</span>
            <div id="dateScroller" class="date-scroller"></div>
        </div>
    </div>

    <script>
        // --- YOUR CREDENTIALS ---
        const SUPABASE_URL = 'https://tqddyuhcddqddviyessk.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxZGR5dWhjZGRxZGR2aXllc3NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NzkxMTYsImV4cCI6MjA4NTU1NTExNn0.nYWIsAnfDFvR4JtujfstvFXyaEtAWgFExRFI38iEDv0';
        
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const PALETTE = ['#B2FF00', '#1AAEFC', '#8455EA', '#F2C94C', '#F2994A', '#EB5757', '#E0E0E0', '#00E0FF'];
        let expenses = []; 
        let categories = JSON.parse(localStorage.getItem('categories')) || ['Food', 'Transport', 'Rent', 'Tech', 'Health', 'Fun'];
        let categoryUsage = JSON.parse(localStorage.getItem('categoryUsage')) || {};
        let categoryColors = JSON.parse(localStorage.getItem('categoryColors')) || {};
        let budgetLimit = parseFloat(localStorage.getItem('budgetLimit')) || 0;
        
        let viewDate = new Date();
        let selectedTimestamp = new Date().setHours(12,0,0,0);
        let currentEditItem = null; 
        let isSummaryMode = false;

        async function init() { await fetchExpenses(); }

        // --- DB OPS ---
        async function fetchExpenses() {
            document.getElementById('loadingIndicator').classList.remove('hidden');
            const { data, error } = await sb.from('expenses').select('*').order('date', { ascending: false });
            if(error) { console.error(error); alert('Sync Error'); }
            else { expenses = data || []; renderAll(); }
            document.getElementById('loadingIndicator').classList.add('hidden');
        }

        async function saveToDb(cat, amt, date, id = null) {
            document.getElementById('loadingIndicator').classList.remove('hidden');
            let error;
            if (id) { const { err } = await sb.from('expenses').update({ category: cat, amount: amt, date: date }).eq('id', id); error = err; } 
            else { const { err } = await sb.from('expenses').insert([{ category: cat, amount: amt, date: date }]); error = err; }
            if (error) alert("Save failed"); else await fetchExpenses();
        }

        async function deleteFromDb(id) {
            if(!confirm("Delete?")) return;
            document.getElementById('loadingIndicator').classList.remove('hidden');
            const { error } = await sb.from('expenses').delete().eq('id', id);
            if(!error) await fetchExpenses();
        }

        // --- APP LOGIC ---
        function openInputMode(isNew = true) {
            document.getElementById('inputOverlay').classList.remove('hidden');
            const scroller = document.getElementById('dateScrollerWrapper');
            scroller.classList.remove('hidden');

            if(isNew) {
                currentEditItem = null;
                document.getElementById('amountInput').value = '';
                document.getElementById('inputHeaderLabel').innerText = "Add New";
                syncSelectedDateToView();
                document.getElementById('dateLocationBottom').appendChild(scroller);
            } else {
                document.getElementById('inputHeaderLabel').innerText = "Edit Entry";
                document.getElementById('dateLocationTop').appendChild(scroller);
            }
            
            document.getElementById('amountInput').focus();
            renderCategories();
            renderDateScroller();
        }

        function closeInputMode() {
            document.getElementById('inputOverlay').classList.add('hidden');
            document.getElementById('amountInput').blur();
            currentEditItem = null;
        }

        function saveTransaction(cat) {
            const raw = document.getElementById('amountInput').value.replace(/\s+/g, '');
            if(!raw) return;
            const amt = parseFloat(raw);
            saveToDb(cat, amt, selectedTimestamp, currentEditItem ? currentEditItem.id : null);
            categoryUsage[cat] = (categoryUsage[cat] || 0) + 1;
            localStorage.setItem('categoryUsage', JSON.stringify(categoryUsage));
            closeInputMode();
        }

        function editItem(item) {
            currentEditItem = item;
            selectedTimestamp = item.date;
            document.getElementById('amountInput').value = Number(item.amount).toLocaleString('hu-HU').replace(/,/g, ' ');
            openInputMode(false); 
        }

        function renderAll() {
            document.getElementById('currentMonthLabel').innerText = viewDate.toLocaleString('en-US', { month: 'long', year: 'numeric' });
            const currentMonthData = expenses.filter(e => {
                const d = new Date(e.date);
                return d.getMonth() === viewDate.getMonth() && d.getFullYear() === viewDate.getFullYear();
            }); // Already sorted by fetch

            const total = currentMonthData.reduce((sum, e) => sum + e.amount, 0);
            document.getElementById('totalDisplay').innerText = `${total.toLocaleString('hu-HU').replace(/,/g, ' ')} Ft`;

            document.getElementById('expenseList').innerHTML = currentMonthData.map((e) => {
                const col = getColor(e.category);
                const isBright = ['#B2FF00', '#F2C94C', '#F2994A', '#E0E0E0', '#00E0FF', '#1AAEFC'].includes(col);
                const textColor = isBright ? '#000000' : '#FFFFFF';
                const metaColor = isBright ? 'rgba(0,0,0,0.6)' : 'rgba(255,255,255,0.6)';
                
                return `
                <li onclick='editById(${e.id})' class="stack-item" style="background-color: ${col}; color: ${textColor}; border-color: ${col}">
                    <div class="flex flex-col">
                        <span class="text-sm font-black uppercase tracking-tight">${e.category}</span>
                        <span class="text-[9px] font-bold uppercase" style="color:${metaColor}">${new Date(e.date).toLocaleDateString('hu-HU')}</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-black text-lg tabular-nums">${Math.round(e.amount).toLocaleString('hu-HU')}</span>
                        <button onclick="event.stopPropagation(); deleteFromDb(${e.id})" class="text-xl px-2" style="opacity:0.3; color:${textColor}">×</button>
                    </div>
                </li>`;
            }).join('');

            updateControlGrid(total);
            if(isSummaryMode) renderSummaryList(currentMonthData, total);
        }
        
        function editById(id) { const item = expenses.find(e => e.id === id); if(item) editItem(item); }

        function updateControlGrid(currentTotal) {
            const budgetLabel = document.getElementById('budgetLeftLabel');
            const waterline = document.getElementById('waterlineFill');
            if (budgetLimit > 0) {
                const left = budgetLimit - currentTotal;
                budgetLabel.innerText = `${left.toLocaleString('hu-HU')} Ft`;
                budgetLabel.style.color = left < 0 ? '#f87171' : '#FFFFFF';
                const pct = Math.min((currentTotal / budgetLimit) * 100, 100);
                waterline.style.width = `${pct}%`;
                waterline.style.backgroundColor = pct > 90 ? '#f87171' : '#FFFFFF';
            } else { budgetLabel.innerText = "TAP TO SET"; waterline.style.width = '0%'; }

            const { prevTotal } = getComparisonData();
            const compContainer = document.getElementById('comparisonContainer');
            if (prevTotal > 0) {
                const diff = currentTotal - prevTotal;
                const pct = ((diff / prevTotal) * 100).toFixed(0);
                if (diff < 0) compContainer.innerHTML = `<span class="pill pill-good">↓ ${Math.abs(pct)}%</span>`;
                else if (diff > 0) compContainer.innerHTML = `<span class="pill pill-bad">↑ ${Math.abs(pct)}%</span>`;
                else compContainer.innerHTML = `<span class="pill pill-neutral">=</span>`;
            } else { compContainer.innerHTML = `<span class="pill pill-neutral">--</span>`; }
        }

        function getComparisonData() {
            let compareDayLimit = 31; const now = new Date();
            if (viewDate.getMonth() === now.getMonth() && viewDate.getFullYear() === now.getFullYear()) compareDayLimit = now.getDate();
            let prevMonthIdx = viewDate.getMonth() - 1; let prevYear = viewDate.getFullYear();
            if (prevMonthIdx < 0) { prevMonthIdx = 11; prevYear -= 1; }
            const prevExpenses = expenses.filter(e => { const d = new Date(e.date); return d.getMonth() === prevMonthIdx && d.getFullYear() === prevYear && d.getDate() <= compareDayLimit; });
            return { prevTotal: prevExpenses.reduce((sum, e) => sum + e.amount, 0), prevExpenses };
        }

        function renderSummaryList(data, grandTotal) {
            const totals = {}; data.forEach(e => totals[e.category] = (totals[e.category] || 0) + e.amount);
            const sorted = Object.entries(totals).sort((a,b) => b[1] - a[1]);
            const { prevExpenses } = getComparisonData();
            const prevTotals = {}; prevExpenses.forEach(e => prevTotals[e.category] = (prevTotals[e.category] || 0) + e.amount);

            document.getElementById('summaryList').innerHTML = sorted.map(([cat, amt]) => {
                const col = getColor(cat);
                const pct = grandTotal > 0 ? (amt / grandTotal * 100).toFixed(0) : 0;
                const prevAmt = prevTotals[cat] || 0;
                let pillHTML = "";
                if (prevAmt > 0) {
                    const diff = amt - prevAmt; const p = ((diff / prevAmt) * 100).toFixed(0);
                    if (diff < 0) pillHTML = `<span class="pill pill-good ml-2">↓ ${Math.abs(p)}%</span>`;
                    else if (diff > 0) pillHTML = `<span class="pill pill-bad ml-2">↑ ${Math.abs(p)}%</span>`;
                    else pillHTML = `<span class="pill pill-neutral ml-2">=</span>`;
                } else if (amt > 0) { pillHTML = `<span class="pill pill-neutral ml-2">NEW</span>`; }

                return `
                <li class="stack-item" style="background: #000; border-color: #333;">
                    <div class="summary-fill" style="width: 0%; background-color: ${col};" data-width="${pct}%"></div>
                    <div class="item-content">
                        <div class="flex items-center"><span class="text-sm font-black uppercase tracking-tight" style="color:${col}">${cat}</span>${pillHTML}</div>
                        <span class="text-md font-black tabular-nums">${Math.round(amt).toLocaleString('hu-HU')} Ft</span>
                    </div>
                </li>`;
            }).join('');
            setTimeout(() => { document.querySelectorAll('.summary-fill').forEach(el => el.style.width = el.getAttribute('data-width')); }, 50);
            renderGraph(data);
        }

        function toggleView() {
            isSummaryMode = !isSummaryMode;
            document.getElementById('controlGrid').classList.toggle('hidden', isSummaryMode);
            document.getElementById('activityView').classList.toggle('hidden', isSummaryMode);
            document.getElementById('summaryView').classList.toggle('hidden', !isSummaryMode);
            if(isSummaryMode) renderAll(); 
        }

        function renderCategories() {
            const sorted = [...categories].sort((a,b) => (categoryUsage[b]||0) - (categoryUsage[a]||0));
            let activeCat = currentEditItem ? currentEditItem.category : null;
            document.getElementById('categoryGrid').innerHTML = sorted.map(c => {
                const activeClass = (c === activeCat) ? 'active-edit' : '';
                return `<button onclick="saveTransaction('${c}')" class="category-btn ${activeClass}">${c}</button>`;
            }).join('');
        }

        function renderDateScroller() {
            const daysInMonth = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 0).getDate();
            let html = '';
            for(let i=1; i<=daysInMonth; i++) {
                const ts = new Date(viewDate.getFullYear(), viewDate.getMonth(), i).setHours(12,0,0,0);
                const isSel = ts === selectedTimestamp;
                html += `<div onclick="selectedTimestamp=${ts}; renderDateScroller()" class="date-card ${isSel?'selected':''}"><span class="text-[9px] font-bold uppercase">DAY</span><span class="text-lg font-black">${i}</span></div>`;
            }
            document.getElementById('dateScroller').innerHTML = html;
            setTimeout(() => { const sel = document.querySelector('.date-card.selected'); if(sel) sel.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' }); }, 10);
        }

        function syncSelectedDateToView() {
            const now = new Date();
            if(now.getMonth() === viewDate.getMonth()) selectedTimestamp = new Date().setHours(12,0,0,0);
            else selectedTimestamp = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).setHours(12,0,0,0);
        }

        function getColor(cat) {
            if(!categoryColors[cat]) { categoryColors[cat] = PALETTE[Object.keys(categoryColors).length % PALETTE.length]; localStorage.setItem('categoryColors', JSON.stringify(categoryColors)); }
            return categoryColors[cat];
        }

        function renderGraph(data) {
            const days = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 0).getDate();
            const daily = new Array(days).fill(0);
            data.forEach(e => daily[new Date(e.date).getDate()-1] += e.amount);
            const max = Math.max(...daily, 10);
            const svg = document.getElementById('spendingChart'); const w = svg.clientWidth || 300; const h = 128; const step = w / (days-1);
            let pts = ""; let area = `0,${h} `;
            daily.forEach((val, i) => { const x = i * step; const y = h - ((val/max) * (h*0.8)); pts += `${x},${y} `; area += `${x},${y} `; });
            area += `${w},${h}`;
            svg.innerHTML = `<defs><linearGradient id="gradient" x1="0" y1="0" x2="0" y2="1"><stop offset="0" stop-color="white" stop-opacity="0.2"/><stop offset="1" stop-color="white" stop-opacity="0"/></linearGradient></defs><polygon points="${area}" class="chart-area" /><polyline points="${pts}" class="chart-line" />`;
        }

        document.getElementById('amountInput').addEventListener('input', (e) => { e.target.value = Number(e.target.value.replace(/[^0-9]/g, '')).toLocaleString('hu-HU').replace(/,/g,' '); });
        window.changeMonth = (d) => { viewDate.setMonth(viewDate.getMonth()+d); init(); };
        window.jumpToToday = () => { viewDate = new Date(); init(); };
        window.setBudget = () => { const n = prompt("Monthly Limit:", budgetLimit); if(n!==null) { budgetLimit = parseFloat(n); localStorage.setItem('budgetLimit', budgetLimit); renderAll(); }};
        window.addNewCategory = () => { const n = prompt("New Category:"); if(n && !categories.includes(n)) { categories.push(n); localStorage.setItem('categories', JSON.stringify(categories)); renderCategories(); }};
        window.exportToCSV = () => { /* CSV Logic */ };

        init();
    </script>
</body>
</html>
